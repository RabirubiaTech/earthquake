name: Update Earthquake Card Image

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pillow requests

      - name: Generate Earthquake Card
        run: |
          python3 << 'EOF'
          import requests
          from PIL import Image, ImageDraw, ImageFont
          from datetime import datetime, timezone
          import io, textwrap

          # ---------------------------------------------------------
          # FETCH USGS 7-DAY FEED (guarantees 3 quakes)
          # ---------------------------------------------------------
          FEED = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson"

          try:
              data = requests.get(FEED, timeout=20).json()
          except:
              data = None

          quakes = []

          # ---------------------------------------------------------
          # FILTER FOR PR REGION + MAG >= 3.5
          # ---------------------------------------------------------
          if data and "features" in data:
              for f in data["features"]:
                  mag = f["properties"]["mag"]
                  place = f["properties"]["place"]
                  time_ms = f["properties"]["time"]
                  lon, lat, depth = f["geometry"]["coordinates"]

                  if mag and mag >= 3.5:
                      if 15 <= lat <= 21.5 and -71 <= lon <= -62:
                          quakes.append({
                              "mag": mag,
                              "place": place,
                              "lat": lat,
                              "lon": lon,
                              "depth": depth,
                              "time": time_ms
                          })

              quakes = sorted(quakes, key=lambda x: x["time"], reverse=True)
              quakes = quakes[:3]

          # ---------------------------------------------------------
          # FORMAT TEXT WITH DATE + TIME + WRAPPING + SPACING
          # ---------------------------------------------------------
          quake_lines_raw = []

          if not quakes:
              quake_lines_raw = ["No recent earthquakes ≥ 3.5 detected."]
          else:
              first = True
              for q in quakes:
                  label = "Currently" if first else "Recent"
                  first = False

                  t = datetime.fromtimestamp(q["time"] / 1000, tz=timezone.utc)
                  time_str = t.strftime("%b %d, %Y %H:%M UTC")

                  line = (
                      f"{label}: M{q['mag']:.1f} – {q['place']} – "
                      f"Depth {int(q['depth'])} km – {time_str}"
                  )

                  quake_lines_raw.extend(textwrap.wrap(line, width=52))
                  quake_lines_raw.append("")  # blank line between entries

          quake_text = "\n".join(quake_lines_raw)

          # ---------------------------------------------------------
          # CARD BACKGROUND
          # ---------------------------------------------------------
          card = Image.new("RGB", (800, 900), "#f2f6fa")
          draw = ImageDraw.Draw(card)

          # ---------------------------------------------------------
          # LOGO
          # ---------------------------------------------------------
          try:
              logo_data = requests.get(
                  "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png",
                  timeout=20
              ).content
              logo = Image.open(io.BytesIO(logo_data)).convert("RGBA")
          except:
              logo = Image.new("RGBA", (120, 120), "white")

          logo = logo.resize((120, 120))
          card.paste(logo, (40, 40), logo)

          # ---------------------------------------------------------
          # FONTS
          # ---------------------------------------------------------
          try:
              font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 36)
              font_sub = ImageFont.truetype("DejaVuSans.ttf", 32)
              font_body = ImageFont.truetype("DejaVuSans.ttf", 21)
              font_footer = ImageFont.truetype("DejaVuSans.ttf", 18)
          except:
              font_title = font_sub = font_body = font_footer = ImageFont.load_default()

          TEXT = "#0a1a2f"

          # ---------------------------------------------------------
          # HEADER
          # ---------------------------------------------------------
          today_str = datetime.now().strftime("%b %d, %Y")
          draw.text((200, 80), today_str, fill=TEXT, font=font_title)

          draw.text((400, 180), "Earthquake Activity", fill=TEXT, font=font_sub, anchor="mm")
          draw.text((400, 230), "Near Puerto Rico (M3.5+)", fill=TEXT, font=font_sub, anchor="mm")

          draw.multiline_text(
              (80, 300),
              quake_text,
              fill=TEXT,
              font=font_body,
              spacing=6
          )

          # ---------------------------------------------------------
          # MINI MAP
          # ---------------------------------------------------------
          LAT_MIN, LAT_MAX = 15, 21.5
          LON_MIN, LON_MAX = -71, -62

          def map_coords(lat, lon):
              x = int((lon - LON_MIN) / (LON_MAX - LON_MIN) * 300)
              y = int((LAT_MAX - lat) / (LAT_MAX - LAT_MIN) * 300)
              return x, y

          map_img = Image.new("RGB", (300, 300), "#d9e3ec")
          map_draw = ImageDraw.Draw(map_img)

          # Quake dots
          for q in quakes:
              x, y = map_coords(q["lat"], q["lon"])
              map_draw.ellipse((x-6, y-6, x+6, y+6), fill="red")

          # ---------------------------------------------------------
          # DETAILED SMOOTHED OUTLINE OF PUERTO RICO
          # ---------------------------------------------------------
          pr_outline = [
              (-67.27, 18.52), (-67.18, 18.50), (-67.10, 18.48), (-67.02, 18.45),
              (-66.95, 18.43), (-66.88, 18.42), (-66.80, 18.40), (-66.72, 18.38),
              (-66.65, 18.36), (-66.58, 18.34), (-66.50, 18.33), (-66.42, 18.32),
              (-66.35, 18.31), (-66.28, 18.30), (-66.20, 18.29), (-66.12, 18.29),
              (-66.05, 18.30), (-65.98, 18.31), (-65.92, 18.33), (-65.86, 18.35),
              (-65.80, 18.37), (-65.75, 18.39), (-65.70, 18.42), (-65.66, 18.45),
              (-65.63, 18.48), (-65.60, 18.52), (-65.58, 18.56), (-65.57, 18.60),
              (-65.57, 18.64), (-65.58, 18.68), (-65.60, 18.72), (-65.63, 18.75),
              (-65.66, 18.78), (-65.70, 18.80), (-65.75, 18.82), (-65.80, 18.84),
              (-65.86, 18.85), (-65.92, 18.86), (-65.98, 18.87), (-66.05, 18.87),
              (-66.12, 18.87), (-66.20, 18.86), (-66.28, 18.85), (-66.35, 18.84),
              (-66.42, 18.82), (-66.50, 18.80), (-66.58, 18.78), (-66.65, 18.76),
              (-66.72, 18.74), (-66.80, 18.72), (-66.88, 18.70), (-66.95, 18.68),
              (-67.02, 18.66), (-67.10, 18.63), (-67.18, 18.60), (-67.27, 18.57)
          ]

          pr_points = [map_coords(lat, lon) for lon, lat in pr_outline]

          map_draw.polygon(
              pr_points,
              fill="#e6e6e6",
              outline="black"
          )

          # ---------------------------------------------------------
          # PLACE MAP LOWER TO AVOID OVERLAP
          # ---------------------------------------------------------
          bordered = Image.new("RGB", (304, 304), "white")
          bordered.paste(map_img, (2, 2))
          card.paste(bordered, (250, 580))

          # ---------------------------------------------------------
          # FOOTER
          # ---------------------------------------------------------
          footer = "USGS Earthquake Data | RabirubiaWeather.com | Updated every 4 hours"
          draw.text((400, 860), footer, fill=TEXT, font=font_footer, anchor="mm")

          card.save("earthquake_card.png", optimize=True)
          EOF

      - name: Commit and push updated image
        run: |
          if [ ! -f earthquake_card.png ]; then
            echo "ERROR: earthquake_card.png not found — aborting commit"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add earthquake_card.png
          git commit -m "Auto-update earthquake card image" || echo "No changes to commit"
          git push
